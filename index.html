<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin: 0 0 10px;
    }
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary { background: #0d6efd; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .card {
      background: #fff;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 14px;
      border-left: 6px solid #0d6efd;
    }
    .hidden { display: none; }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>Login</h1>
  <select id="role">
    <option value="ceo">CEO</option>
    <option value="manager">Manager</option>
    <option value="expediter">Expediter</option>
  </select>
  <button class="btn-primary" onclick="login()">Login</button>
</div>

<!-- CEO -->
<div id="ceo" class="hidden">
  <div class="topbar">
    <h1>CEO Dashboard</h1>
    <button class="btn-secondary" onclick="logout()">Logout</button>
  </div>
  <!-- "No Available Projects" message -->
  <p id="noProjectsMessage" class="hidden" style="color: red; font-size: 16px;">No Available Projects.</p>
  <div id="ceoProjects"></div>
</div>

<!-- MANAGER -->
<div id="manager" class="hidden">
  <div class="topbar">
    <h1>Manager Dashboard</h1>
    <button class="btn-secondary" onclick="logout()">Logout</button>
  </div>

  <div id="managerProjects"></div>

  <button class="btn-primary" onclick="openCreate()">Create Project</button>
</div>

<!-- EXPEDITER -->
<div id="expediter" class="hidden">
  <div class="topbar">
    <h1>Expediter Dashboard</h1>
    <button class="btn-secondary" onclick="logout()">Logout</button>
  </div>
  <div id="expediterProjects"></div>
</div>

<!-- PROJECT FORM -->
<div id="projectForm" class="hidden">
  <h2 id="formTitle">Create Project</h2>

  <input id="pName" placeholder="Project Name (required)" />
  <input id="pLocation" placeholder="Location" />
  <input id="pBudget" type="number" placeholder="Budget" />
  <input id="pStart" type="date" />
  <input id="pTarget" type="date" />
  <input id="pStatus" placeholder="Status" />

  <button class="btn-primary" onclick="saveProject()">Save</button>
  <button class="btn-secondary" onclick="closeForm()">Cancel</button>
</div>

<script>
let editId = null;

function getProjects() {
  return JSON.parse(localStorage.getItem("projects") || "[]");
}

function saveProjects(data) {
  localStorage.setItem("projects", JSON.stringify(data));
}

function normalizeProjects() {
  const projects = getProjects();
  let changed = false;

  projects.forEach(p => {
    if (!p.id) {
      p.id = Date.now().toString();
      changed = true;
    }
  });

  if (changed) saveProjects(projects);
}

function login() {
  const role = document.getElementById("role").value;
  localStorage.setItem("role", role);
  render();
}

function logout() {
  localStorage.removeItem("role");
  location.reload();
}

function render() {
  ["login","ceo","manager","expediter","projectForm"].forEach(id =>
    document.getElementById(id).classList.add("hidden")
  );

  const role = localStorage.getItem("role");
  if (!role) {
    login.classList.remove("hidden");
    return;
  }

  normalizeProjects();

  if (role === "ceo") {
    ceo.classList.remove("hidden");
    renderCEO();
  }

  if (role === "manager") {
    manager.classList.remove("hidden");
    renderManager();
  }

  if (role === "expediter") {
    expediter.classList.remove("hidden");
    renderExpediter();
  }
}

function renderCEO() {
  const list = ceoProjects;
  const msg = noProjectsMessage;
  const projects = getProjects();

  list.innerHTML = "";

  if (projects.length === 0) {
    msg.classList.remove("hidden");
    return;
  }

  msg.classList.add("hidden");
  projects.forEach(p => {
    list.innerHTML += `
      <div class="card">
        <strong>${p.name}</strong><br>
        Location: ${p.location || "-"}<br>
        Budget: ${p.budget || "-"}<br>
        Status: ${p.status || "-"}
      </div>`;
  });
}

function renderManager() {
  managerProjects.innerHTML = "";
  getProjects().forEach(p => {
    managerProjects.innerHTML += `
      <div class="card">
        <strong>${p.name}</strong><br>
        Budget: ${p.budget || "-"}<br><br>
        <button class="btn-secondary" onclick="editProject('${p.id}')">Edit</button>
        <button class="btn-danger" onclick="deleteProject('${p.id}')">Delete</button>
      </div>`;
  });
}

function renderExpediter() {
  expediterProjects.innerHTML = "";
  getProjects().forEach(p => {
    expediterProjects.innerHTML += `
      <div class="card">
        <strong>${p.name}</strong><br>
        Budget: ${p.budget || "-"}<br><br>

        <h3>Expenses</h3>
        <div id="expenses-${p.id}"></div>
        <input id="newExpense-${p.id}" type="number" placeholder="Expense amount">
        <button class="btn-primary" onclick="addExpense('${p.id}')">Add Expense</button>
      </div>`;
    renderExpenses(p.id);
  });
}

function renderExpenses(projectId) {
  const projects = getProjects();
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const box = document.getElementById(`expenses-${projectId}`);
  box.innerHTML = "";

  let total = 0;
  project.expenses = project.expenses || [];

  project.expenses.forEach((e, i) => {
    total += e.amount;
    box.innerHTML += `
      <div>
        ₱${e.amount}
        <button class="btn-danger" onclick="deleteExpense('${projectId}', ${i})">x</button>
      </div>`;
  });

  box.innerHTML += `<br><strong>Total: ₱${total}</strong>`;
}

function addExpense(projectId) {
  const input = document.getElementById(`newExpense-${projectId}`);
  const amount = Number(input.value);

  if (!amount || amount <= 0) {
    alert("Invalid amount");
    return;
  }

  const projects = getProjects();
  const project = projects.find(p => p.id === projectId);

  project.expenses = project.expenses || [];
  project.expenses.push({ amount });

  saveProjects(projects);
  renderExpediter();
}

function deleteExpense(projectId, index) {
  const projects = getProjects();
  const project = projects.find(p => p.id === projectId);

  project.expenses.splice(index, 1);
  saveProjects(projects);
  renderExpediter();
}

function openCreate() {
  editId = null;
  formTitle.innerText = "Create Project";
  projectForm.classList.remove("hidden");
}

function editProject(id) {
  const p = getProjects().find(x => x.id === id);
  editId = id;
  pName.value = p.name;
  pLocation.value = p.location;
  pBudget.value = p.budget;
  pStart.value = p.start;
  pTarget.value = p.target;
  pStatus.value = p.status;
  projectForm.classList.remove("hidden");
}

function saveProject() {
  if (!pName.value.trim()) return alert("Project name required");

  const projects = getProjects();
  if (editId) {
    Object.assign(projects.find(p => p.id === editId), collect());
  } else {
    projects.push({ id: Date.now().toString(), ...collect() });
  }

  saveProjects(projects);
  closeForm();
  render();
}

function collect() {
  return {
    name: pName.value,
    location: pLocation.value,
    budget: Number(pBudget.value),
    start: pStart.value,
    target: pTarget.value,
    status: pStatus.value,
    expenses: []
  };
}

function deleteProject(id) {
  saveProjects(getProjects().filter(p => p.id !== id));
  render();
}

function closeForm() {
  projectForm.classList.add("hidden");
  [pName,pLocation,pBudget,pStart,pTarget,pStatus].forEach(i => i.value = "");
}

render();
</script>

</body>
</html>
