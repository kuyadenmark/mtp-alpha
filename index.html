<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Project Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 20px;
}
h1 { margin-bottom: 10px; }
button {
  padding: 10px 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.btn-primary { background: #0d6efd; color: #fff; }
.btn-danger { background: #dc3545; color: #fff; }
.btn-secondary { background: #6c757d; color: #fff; }
.card {
  background: #fff;
  border-radius: 6px;
  padding: 16px;
  margin-bottom: 14px;
  border-left: 6px solid #0d6efd;
}
.hidden { display: none; }
input, select {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}
.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h1>Login</h1>
  <select id="role">
    <option value="ceo">CEO</option>
    <option value="manager">Manager</option>
    <option value="expediter">Expediter</option>
  </select>
  <button class="btn-primary" onclick="login()">Login</button>
</div>

<!-- CEO -->
<div id="ceo" class="hidden">
  <div class="topbar">
    <h1>CEO Dashboard</h1>
    <button class="btn-secondary" onclick="logout()">Logout</button>
  </div>
  <p id="noProjects" class="hidden">No Available Projects.</p>
  <div id="ceoProjects"></div>
</div>

<!-- MANAGER -->
<div id="manager" class="hidden">
  <div class="topbar">
    <h1>Manager Dashboard</h1>
    <button class="btn-secondary" onclick="logout()">Logout</button>
  </div>
  <div id="managerProjects"></div>
  <button class="btn-primary" onclick="openCreate()">Create Project</button>
</div>

<!-- EXPEDITER -->
<div id="expediter" class="hidden">
  <div class="topbar">
    <h1>Expediter Dashboard</h1>
    <button class="btn-secondary" onclick="logout()">Logout</button>
  </div>
  <div id="expediterProjects"></div>
</div>

<!-- PROJECT FORM -->
<div id="projectForm" class="hidden">
  <h2 id="formTitle">Create Project</h2>
  <input id="pName" placeholder="Project Name (required)" />
  <input id="pLocation" placeholder="Location" />
  <input id="pBudget" type="number" placeholder="Budget" />
  <input id="pStart" type="date" />
  <input id="pTarget" type="date" />
  <input id="pStatus" placeholder="Status" />
  <button class="btn-primary" onclick="saveProject()">Save</button>
  <button class="btn-secondary" onclick="closeForm()">Cancel</button>
</div>

<script>
let editId = null;

const getProjects = () =>
  JSON.parse(localStorage.getItem("projects") || "[]");

const saveProjects = data =>
  localStorage.setItem("projects", JSON.stringify(data));

function login() {
  localStorage.setItem("role", role.value);
  render();
}

function logout() {
  localStorage.clear();
  location.reload();
}

function render() {
  ["login","ceo","manager","expediter","projectForm"].forEach(id =>
    document.getElementById(id).classList.add("hidden")
  );

  const role = localStorage.getItem("role");
  if (!role) return login.classList.remove("hidden");

  if (role === "ceo") { ceo.classList.remove("hidden"); renderCEO(); }
  if (role === "manager") { manager.classList.remove("hidden"); renderManager(); }
  if (role === "expediter") { expediter.classList.remove("hidden"); renderExpediter(); }
}

/* CEO */
function renderCEO() {
  const projects = getProjects();
  ceoProjects.innerHTML = "";
  noProjects.classList.toggle("hidden", projects.length > 0);

  projects.forEach(p => {
    ceoProjects.innerHTML += `
      <div class="card">
        <strong>${p.name}</strong><br>
        Location: ${p.location || "-"}<br>
        Budget: ${p.budget || "-"}<br>
        Status: ${p.status || "-"}
      </div>`;
  });
}

/* MANAGER */
function renderManager() {
  managerProjects.innerHTML = "";
  getProjects().forEach(p => {
    managerProjects.innerHTML += `
      <div class="card">
        <strong>${p.name}</strong><br>
        Budget: ${p.budget || "-"}<br><br>
        <button class="btn-secondary" onclick="editProject('${p.id}')">Edit</button>
        <button class="btn-danger" onclick="deleteProject('${p.id}')">Delete</button>
      </div>`;
  });
}

/* EXPEDITER â€” FIXED */
function renderExpediter() {
  expediterProjects.innerHTML = "";
  getProjects().forEach(p => {
    if (!p.expenses) p.expenses = [];

    const total = p.expenses.reduce((s,e)=>s+e.amount,0);
    const remaining = (p.budget || 0) - total;

    expediterProjects.innerHTML += `
      <div class="card">
        <strong>${p.name}</strong><br>
        Budget: ${p.budget || 0}<br>
        Total Expenses: ${total}<br>
        Remaining: ${remaining}<br><br>

        <input id="exp-${p.id}" type="number" placeholder="Expense amount">
        <button class="btn-primary" onclick="addExpense('${p.id}')">Add Expense</button>

        ${p.expenses.map((e,i)=>`
          <div>
            ${e.amount}
            <button class="btn-danger" onclick="deleteExpense('${p.id}',${i})">X</button>
          </div>`).join("")}
      </div>`;
  });
}

function addExpense(id) {
  const input = document.getElementById("exp-"+id);
  const amount = Number(input.value);
  if (!amount) return alert("Enter amount");

  const projects = getProjects();
  const p = projects.find(x => x.id === id);
  p.expenses.push({ amount });
  saveProjects(projects);
  renderExpediter();
}

function deleteExpense(id, i) {
  const projects = getProjects();
  const p = projects.find(x => x.id === id);
  p.expenses.splice(i,1);
  saveProjects(projects);
  renderExpediter();
}

/* PROJECT CRUD */
function openCreate() {
  editId = null;
  projectForm.classList.remove("hidden");
}

function editProject(id) {
  const p = getProjects().find(x => x.id === id);
  editId = id;
  pName.value = p.name;
  pLocation.value = p.location;
  pBudget.value = p.budget;
  pStatus.value = p.status;
  projectForm.classList.remove("hidden");
}

function saveProject() {
  if (!pName.value.trim()) return alert("Name required");
  const projects = getProjects();

  if (editId) {
    Object.assign(projects.find(p=>p.id===editId), collect());
  } else {
    projects.push({ id: Date.now().toString(), expenses: [], ...collect() });
  }

  saveProjects(projects);
  closeForm(); render();
}

const collect = () => ({
  name: pName.value,
  location: pLocation.value,
  budget: Number(pBudget.value),
  status: pStatus.value
});

function deleteProject(id) {
  saveProjects(getProjects().filter(p=>p.id!==id));
  render();
}

function closeForm() {
  projectForm.classList.add("hidden");
  pName.value=pLocation.value=pBudget.value=pStatus.value="";
}

render();
</script>
</body>
</html>
